import requests
import json

import CoolTools as ct

# Запоминает url куда отправлять
# Умеет запоминать какие флаги уже были отправлены
# Предотвращает отправку повторных флагов
# Сохраняет файл с отправленными флагами в ту же директорию
# Читает отправленные флаги из файла (на случай краша и рестарта)


class CoolFlagManager:

    name = "[Cool flag manager]  "
    check_regex = False
    flags = []

    def __init__(self, teamToken, url="http://10.0.0.1:8080/flags"):
        print(self.name + "Cool flag manager makes brrrrr")

        self.url = url
        self.headers = {
            'Content-type': 'application/json',
            "X-Team-Token": teamToken,
        }

        try:
            self.flags_in_file = open("Sended flags.txt", "r")
            for f in self.flags_in_file.readlines():
                self.flags.append(f[:-1])
        except FileNotFoundError:
            pass

        self.flags_in_file = open("Sended flags.txt", "a")

    def SendFlag(self, flag):
        return self.SendFlags([flag])

    def SendFlags(self, flags):
        print(self.name + "Send flags")

        flags = self.FilterNewFlags(flags)

        if not flags:
            print(self.name + "No new flags! Don't send(")
            return ""

        r = requests.put(self.url,
                         data=json.dumps(flags),
                         headers=self.headers)

        print(r.text)
        self.RememberFlags(flags)
        return r.text

    def RememberFlags(self, flags):
        print(self.name + "Store new flags:")
        print("\n".join(flags))

        self.flags += flags

        for f in flags:
            self.flags_in_file.write(f + '\n')

    def FilterNewFlags(self, flags):
        flags = [f for f in flags if ct.isFlag(f) and f not in self.flags]
        return list(set(flags))

    def Close(self):
        self.flags_in_file.close()
