import requests
import json

# Запоминает url куда отправлять
# Умеет запоминать какие флаги уже были отправлены
# Предотвращает отправку повторных флагов
# Сохраняет файл с отправленными флагами в ту же директорию
# Читает отправленные флаги из файла (на случай краша и рестарта)

class CoolFlagManager:

    name = "[Cool flag manager]  "

    def __init__(self, teamToken, url="http://10.0.0.1:8080/flags"):
        print(self.name + "Cool flag manager makes brrrrr")

        self.url = url
        self.headers = {
            'Content-type': 'application/json',
            "X-Team-Token": teamToken,
        }

        with open("Sended flags.txt") as flags_in_file:
            self.flags = flags_in_file.readlines()

        self.flags_in_file = open("Sended flags.txt", "w")

    def SendFlag(self, flag):
        return self.SendFlags([flag])

    def SendFlags(self, flags):
        print(self.name + "Send flags")

        flags = [f for f in flags if f not in self.flags]

        if not flags:
            print(self.name + "No new flags! Don't send(")
            return ""

        r = requests.put(self.url, data=json.dumps(
            flags), headers=self.headers)

        print(r.text)
        self.RememberFlags(flags)
        return r.text

    def RememberFlags(self, flags):
        print(self.name + "Store new flags:")
        print("\n".join(flags))

        self.flags += flags
        self.flags_in_file.writelines(flags)

    def Close(self):
        self.flags_in_file.close()
